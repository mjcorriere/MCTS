<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title></title>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
  <style type="text/css">

    .board {
      position: relative;
      width: 700px;
      height: 600px;
      border-top: 1px solid #AAA;
      border-left: 1px solid #AAA;
      background-color: #000;
    }

    .board .row {
      width: auto;
      height: 100px;
      background-color: #eee;
      box-sizing: border-box;
    }

    .board .cell {
      width: 100px;
      height: 100px;
      display: inline-block;
      border-right: 1px solid #AAA;
      border-bottom: 1px solid #AAA;
      border-collapse: collapse;
      box-sizing: border-box;
    }

    .token {
      width: 100px;
      height: 100px;
      border-radius: 50px;
    }

    .token.animated {
      position: absolute;
    }

    .token.p1 {
      background-color: #333;
    }

    .token.p2 {
      background-color: #E33;
    }

  </style>
</head>
<body>

  <h1>A Board</h1>
  <div class="board"></div>

  <script type="text/javascript">
    var WIDTH = 7;
    var HEIGHT = 6;

    function Gamestate() {
      //TODO: Make this dynamically created
      this.board = [
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
      ];

      this.currentPlayer = 1;
      this.width = WIDTH;
      this.height = HEIGHT;
      this.winner = null;

    }

    Gamestate.prototype.executeMove = function(move) {
      var column = [];
      var row = -1;

      for (var r = 0; r < this.board.length; r++) {
        column.push(this.board[r][move]);
      }

      for (var r = column.length - 1; r >= 0; r--) {
        if (column[r] == 0) {
          row = r;
          break;
        }
      }

      if (row != -1) {
        this.board[row][move] = this.currentPlayer;
        this.checkForWin(row, move, this.currentPlayer);
        this.currentPlayer = 3 - this.currentPlayer;
      }

      return row;

    }

    Gamestate.prototype.getLegalMoves = function() {

      var first_row = this.board[0];
      var legalMoves = [];

      for (var i = 0; i < first_row.length; i++) {
        if (first_row[i] == 0) {
          legalMoves.push(i);
        }
      }

      return legalMoves;

    }

    Gamestate.prototype.checkForWin = function(_r, _c, player) {

      var rmin = clamp(_r - 3, 0, this.height);
      var rmax = clamp(_r + 3, 0, this.height - 1);
      var cmin = clamp(_c - 3, 0, this.width);
      var cmax = clamp(_c + 3, 0, this.width - 1);

      row = this.board[_r];
      var col = [];
      for (var r = 0; r < this.board.length; r++) {
        col.push(this.board[r][_c]);
      }

      // Check column for victory
      var count = 0;
      for (var c = cmin; c <= cmax; c++) {
        if (row[c] == player) {
          count += 1;
        } else {
          count = 0;
        }

        if (count == 4) {
          this.winner = player;
        }
      }

      // Check row for victory
      var count = 0;
      for (var r = rmin; r <= rmax; r++) {
        if (col[r] == player) {
          count += 1;
        } else {
          count = 0;
        }

        if (count == 4) {
          this.winner = player;
        }
      }

      // Check diagonal direction -> /
      var count = 0;
      var row_indicies = [];
      var col_indicies = [];

      for (var i = rmax; i >= rmin; i--) {
        row_indicies.push(i);
      }

      for (var i = cmin; i <= cmax; i++) {
        col_indicies.push(i);
      }

      var indicies = zip(row_indicies, col_indicies);

      for (var i = 0; i < indicies.length; i++) {
        var r = indicies[i][0];
        var c = indicies[i][1];

        if (this.board[r][c] == player) {
          count += 1;
        } else {
          count = 0;
        }

        if (count == 4) {
          this.winner = player;
        }

      }

      // Check diagonal direction -> \
      var count = 0;
      var row_indicies = [];
      var col_indicies = [];

      for (var i = rmin; i <= rmax; i++) {
        row_indicies.push(i);
      }

      for (var i = cmin; i <= cmax; i++) {
        col_indicies.push(i);
      }

      var indicies = zip(row_indicies, col_indicies);

      for (var i = 0; i < indicies.length; i++) {
        var r = indicies[i][0];
        var c = indicies[i][1];

        if (this.board[r][c] == player) {
          count += 1;
        } else {
          count = 0;
        }

        if (count == 4) {
          this.winner = player;
        }

      }

      // If the top row has no empty slots and we got here, its a draw
      if (this.board[0].indexOf(0) == -1) {
        this.winner = 0;
      }


    }

    Gamestate.prototype.copy = function() {

      var gameState = new Gamestate();
      for (var r = 0; r < this.board.length; r++) {
        gameState.board[r] = this.board[r].slice(0);
      }
      gameState.currentPlayer = this.currentPlayer;
      gameState.winner = this.winner;

      return gameState;

    }

    var cf = new Gamestate();

    $board = $(".board");

    for (var i = 0; i < HEIGHT; i++) {
      var $newRow = $("<div>").addClass("row");
      $board.append($newRow);

      for (var j = 0; j < WIDTH; j++) {
        var columnNumber = "col" + j;
        var newCell = $("<div>").addClass("cell").addClass(columnNumber);
        $newRow.append(newCell);
      }

    }

    $board.delegate(".cell", "mouseover mouseout", function(event) {
      var color;
      var index = $(this).index();
      var columnNumber = ".col" + index;
      if (event.type == "mouseover") {
        color = "#CCC";
      } else if (event.type == "mouseout") {
        color = "#EEE";
      }

      $board.find(columnNumber).css("background-color", color);

    });

    $board.delegate(".cell", "click", function(event) {

      // If someone has won, don't bother with trying to place a piece sillyhead
      if (cf.winner != null) {
        return
      }

      var col = $(this).index();
      var player = cf.currentPlayer;
      var row = cf.executeMove(col);

      if (row != -1) {
        var $row = $board.children().eq(row);
        var $cell = $row.children().eq(col);

        var $token = $("<div>").addClass("token").addClass("p" + player);

        var x = (100 * col) + "px";
        var y = (100 * row) + "px";

        var $animatedToken = $("<div>")
          .addClass("token")
          .addClass("animated")
          .addClass("p" + player)
          .css({"left": x})
          .css({"top": "0px"});

        $board.append($animatedToken);

        $animatedToken.animate({"top": y}, 300, function() {
            $cell.append($token);
            $(this).remove();
        });

        cf.checkForWin(row, col, player);
        if (cf.winner == null) {
          console.log('no winner yet');
        } else if (cf.winner == 1) {
          console.log('player 1 wins');
        } else if (cf.winner == 2) {
          console.log('player 2 wins');
        } else if (cf.winner == 0) {
          console.log('its a draw baby');
        }

      }

    });

    // Utility functions
    function clamp(value, minimum, maximum) {
      return Math.max(minimum, Math.min(value, maximum));
    }

    function zip(array1, array2) {

      var length = Math.min(array1.length, array2.length);
      var zipped = [];

      for (var i = 0; i < length; i++) {
          zipped.push([array1[i], array2[i]]);
      }

      return zipped;

    }

  </script>

</body>
</html>
